from sympy import symbols, integrate, sympify, pprint, Integral
from sympy.integrals.manualintegrate import integral_steps
from sympy.core.sympify import SympifyError
import re

def fix_common_errors(expr_str):
    # è‡ªåŠ¨ä¿®å¤çœç•¥æ‹¬å·çš„å‡½æ•°è¡¨è¾¾å¼ï¼Œå¦‚ sinx â†’ sin(x)
    functions = ['sin', 'cos', 'tan', 'sec', 'csc', 'cot', 'exp', 'log', 'sqrt']
    for func in functions:
        expr_str = re.sub(rf'\b{func}([a-zA-Z0-9]+)', rf'{func}(\1)', expr_str)
    return expr_str

def is_elementary_integral(expr, var):
    # åˆ¤æ–­ç§¯åˆ†æ˜¯å¦ä¸ºåˆç­‰å‡½æ•°ç§¯åˆ†
    steps = integral_steps(expr, var)
    return steps is not None

def main():
    print("ğŸ”¢ å¤šå˜é‡ç§¯åˆ†è®¡ç®—å™¨ï¼šæ”¯æŒä¸å®šç§¯åˆ† / å®šç§¯åˆ†")
    var_name = input("è¯·è¾“å…¥å˜é‡åï¼ˆå¦‚ xï¼‰ï¼š").strip()
    var = symbols(var_name)

    expr_input = input(f"è¯·è¾“å…¥å…³äº {var_name} çš„ç§¯åˆ†è¡¨è¾¾å¼ï¼ˆå¦‚ sinx / x^2ï¼‰ï¼š").strip()
    expr_input = fix_common_errors(expr_input)

    try:
        expr = sympify(expr_input)
    except SympifyError:
        print("âŒ æ— æ³•è§£æè¡¨è¾¾å¼ï¼Œè¯·æ£€æŸ¥è¯­æ³•æ˜¯å¦æ­£ç¡®ã€‚")
        return

    # æ˜¯å¦å®šç§¯åˆ†ï¼Ÿ
    definite = input("æ˜¯å¦è¿›è¡Œå®šç§¯åˆ†ï¼Ÿ(y/n)ï¼š").strip().lower()
    if definite == 'y':
        try:
            a = float(input("è¯·è¾“å…¥ç§¯åˆ†ä¸‹é™ï¼ˆä¾‹å¦‚ 0ï¼‰ï¼š"))
            b = float(input("è¯·è¾“å…¥ç§¯åˆ†ä¸Šé™ï¼ˆä¾‹å¦‚ piï¼‰ï¼š"))
            integral_result = integrate(expr, (var, a, b))
            print("\nğŸ“Œ å®šç§¯åˆ†è¡¨è¾¾å¼ä¸ºï¼š")
            pprint(Integral(expr, (var, a, b)), use_unicode=True)
            print("\nâœ… ç§¯åˆ†ç»“æœä¸ºï¼š")
            pprint(integral_result, use_unicode=True)
        except Exception as e:
            print("âŒ è¾“å…¥çš„ä¸Šä¸‹é™æœ‰è¯¯ï¼Œè¯·ç¡®ä¿æ˜¯æ•°å­—æˆ–å¸¸æ•°ç¬¦å·ã€‚")
    else:
        print("\nğŸ“Œ ä¸å®šç§¯åˆ†è¡¨è¾¾å¼ä¸ºï¼š")
        pprint(Integral(expr, var), use_unicode=True)
        if is_elementary_integral(expr, var):
            result = integrate(expr, var)
            print("\nâœ… ç»“æœæ˜¯ä¸€ä¸ªå¯ç”¨åˆç­‰å‡½æ•°è¡¨ç¤ºçš„ç§¯åˆ†ï¼š")
            pprint(result, use_unicode=True)
        else:
            result = integrate(expr, var, evaluate=False)
            print("\nâš ï¸ è¯¥ç§¯åˆ†ä¸èƒ½ç”¨åˆç­‰å‡½æ•°è¡¨ç¤ºï¼ˆä¿ç•™ç¬¦å·å½¢å¼ï¼‰ï¼š")
            pprint(result, use_unicode=True)

if __name__ == "__main__":
    main()
